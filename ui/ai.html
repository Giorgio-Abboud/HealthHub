<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Agent</title>
    <style>
      body { font-family: Inter, system-ui, Arial; padding: 24px; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; max-width: 720px; }
      textarea { width: 100%; min-height: 120px; }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Verify UUID</h2>
      <input id="uuid" placeholder="Enter your UUID" style="width: 100%;" />
      <button id="verify">Verify</button>
      <p id="verify-status"></p>
    </div>

    <div class="card" style="margin-top: 16px;">
      <h2>Chat</h2>
      <textarea id="message" placeholder="Ask the agent..." disabled></textarea>
      <button id="send" disabled>Send</button>
      <pre id="reply"></pre>
    </div>

    <script type="module">
      const API_URL = 'http://localhost:8080'
      const AGENT_URL = 'http://localhost:8001'
      const $ = (id) => document.getElementById(id)

      function openDB() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open('healthhub-db', 1)
          req.onsuccess = () => resolve(req.result)
          req.onerror = () => reject(req.error)
        })
      }
      async function getLocalUser(uuid) {
        const db = await openDB()
        return new Promise((resolve, reject) => {
          const tx = db.transaction('users', 'readonly')
          const store = tx.objectStore('users')
          const req = store.get(uuid)
          req.onsuccess = () => resolve(req.result)
          req.onerror = () => reject(req.error)
        })
      }

      let currentUserId = null

      $('verify').onclick = async () => {
        const id = $('uuid').value.trim()
        if (!id) return

        // Online verify (optional)
        let existsOnline = false
        try {
          const res = await fetch(`${API_URL}/users/${id}/exists`)
          const data = await res.json()
          existsOnline = !!data.exists
        } catch (_) {}

        const localUser = await getLocalUser(id)

        if (existsOnline || localUser) {
          $('verify-status').textContent = 'User verified (online or local). You can chat now.'
          $('message').disabled = false
          $('send').disabled = false
          currentUserId = id
        } else {
          $('verify-status').textContent = 'User not found. Please create an account first.'
          $('message').disabled = true
          $('send').disabled = true
          currentUserId = null
        }
      }

      $('send').onclick = async () => {
        const msg = $('message').value.trim()
        if (!currentUserId || !msg) return
        const localUser = await getLocalUser(currentUserId)

        // Example: use "profile" agent. You can switch to /agent/triage or /agent/qa.
        const res = await fetch(`${AGENT_URL}/agent/profile`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: currentUserId,
            patient_info: localUser || null,
            message: msg
          })
        })
        const data = await res.json()
        $('reply').textContent = JSON.stringify(data, null, 2)
      }
    </script>
  </body>
</html>
